if(!window["String"]["prototype"]["trim"]){window["String"]["prototype"]["trim"]=function(){return this.replace(/^\s+|\s+$/g,"")}}var JELON=window.JELON||{};(function(JL){var constants={ACCESS_TOKEN_KEY:"xups-github-comments-token",USER_INFO_KEY:"xups-github-user-info",PER_PAGE:5,API_HOST:"https://api.github.com"};var queryUrl=function(e,s,t){s=s||location.href;var a=new RegExp("(\\?|&|#|&amp;)"+e+"=([^?&#]*)");var n=s.match(a);if(t){return n?n[2]:""}return n?decodeURIComponent(n[2]):""};var $=JL.$||function(e){return/^(\[object HTML)[a-zA-Z]*(Element\])$/.test(Object.prototype.toString.call(e))?e:document.getElementById(e)};var addClass=function(e,s){if(!e)return;var t;var a;var n,i,r;if(e instanceof Array){for(n=0,i=e.length;n<i;n++){e[n]=arguments.callee.call(this,e[n],s)}}else if(typeof e.item==="function"){var o=[];for(n=0,i=e.length;n<i;n++){o.push(arguments.callee.call(this,e.item(n),s))}e=o}else{e=$(e);if(!e)return;if(s&&typeof s==="string"){t=s.split(/\s+/);if(e.nodeType===1){if(!e.className&&t.length===1){e.className=s}else{a=" "+e.className+" ";for(n=0,r=t.length;n<r;n++){if(a.indexOf(" "+t[n]+" ")<0){a+=t[n]+" "}}e.className=a.trim()}}}}return e};var removeClass=function(e,s){if(!e)return;var t,a,n,i,r;if(e instanceof Array){for(a=0,n=e.length;a<n;a++){e[a]=arguments.callee.call(this,e[a],s)}}else if(typeof e.item==="function"){var o=[];for(a=0,n=e.length;a<n;a++){o.push(arguments.callee.call(this,e.item(a),s))}e=o}else{e=$(e);if(!e)return;if(s&&typeof s==="string"||s===undefined){t=(s||"").split(/\s+/);if(e.nodeType===1&&e.className){if(s){s=(" "+e.className+" ").replace(/[\n\t\r]/g," ");for(i=0,r=t.length;i<r;i++){s=s.replace(" "+t[i]+" "," ")}e.className=s.trim()}else{e.className=""}}}}return e};var ajax=function(e){e=e||{};e.method=e.method.toUpperCase()||"POST";e.url=e.url||"";e.async=e.async||true;e.data=e.data||null;e.success=e.success||function(){};var s=null;if(window.XMLHttpRequest){s=new XMLHttpRequest}else{s=new ActiveXObject("Microsoft.XMLHTTP")}var t=[];var a=window.localStorage.getItem(constants.ACCESS_TOKEN_KEY);for(var n in e.data){t.push(n+"="+e.data[n])}var i=t.join("&");if(e.method.toUpperCase()==="POST"){s.open(e.method,e.url,e.async);if(window.JSON){i=JSON.stringify(e.data);s.setRequestHeader("Content-Type","application/json;charset=utf-8")}else{s.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8")}if(e.headers&&e.headers["Accept"]){s.setRequestHeader("Accept",e.headers["Accept"])}else{s.setRequestHeader("Accept","application/vnd.github.squirrel-girl-preview, application/vnd.github.html+json")}if(a){s.setRequestHeader("Authorization","token "+a)}s.send(i)}else if(e.method.toUpperCase()==="GET"){s.open(e.method,e.url+"?"+i,e.async);s.setRequestHeader("Accept","application/vnd.github.squirrel-girl-preview, application/vnd.github.html+json");if(a){s.setRequestHeader("Authorization","token "+a)}s.send(null)}s.onreadystatechange=function(){if(s.readyState===4){if(s.status>=200&&s.status<300){e.success&&e.success(s.responseText)}else{e.fail&&e.fail(s.status)}}};s.onerror=function(){e.fail&&e.fail({message:"请求错误！"})}};JL.issueComments=0;JL.issueNumber=0;JL.Utils={ajax:ajax,queryUrl:queryUrl,addClass:addClass,removeClass:removeClass};JL.Renders={box:{tpl:['<section class="box" id="JELON__commentBox">','<div class="com-avatar"><img id="JELON__loginAvatar" src="/img/unsigned_avatar.jpg" alt="avatar"></div>','<div class="com-text">','<div class="main">','<textarea class="text-area-edited show" id="JELON__editBox" placeholder="欢迎评论！"></textarea>','<div class="text-area-preview" id="JELON__previewBox"></div>',"</div>",'<div class="switch">','<div class="switch-item on" id="JELON__editSwitcher" onclick="JELON.Actions.editPreviewSwitch(\'edit\')">编辑</div>','<div class="switch-item" id="JELON__previewSwitcher" onclick="JELON.Actions.editPreviewSwitch(\'preview\')">预览</div>',"</div>",'<div class="button" onclick="JELON.Actions.postComment()">提交</div>',"</div>","</section>"].join(""),update:function(){var e=localStorage.getItem(constants.USER_INFO_KEY);if(e){e=JSON.parse(e)}else{e={}}$("JELON__loginAvatar").src=e.avatar_url||"/img/unsigned_avatar.jpg"}},list:{tpl:['<section class="list-wrap" id="JELON__commentList">','<div class="text-center">正在加载评论</div>',"</section>"].join(""),update:function(e,s,t,a){var n=5;var i="";var r=[];var o=[];var c=Math.ceil(s/constants.PER_PAGE);if(s===0){i='<div class="text-center">暂无评论</div>'}else{var l="";var u="";for(var d=0,m=t.length;d<m;d++){l=["<li>",'<div class="user-avatar">','<a target="_blank" href="'+t[d].user.html_url+'">','<img src="'+t[d].user.avatar_url+'" alt="user-avatar">',"</a>","</div>",'<div class="user-comment">','<div class="user-comment-header" id="JELON__comment_'+t[d].id+'_reactions">','<span class="post-name">'+t[d].user.login+"</span>",'<span class="post-time">'+t[d].created_at+"</span>",'<span class="like" onclick="JELON.Actions.like('+t[d].id+')">点赞</span>','<span class="like-num">'+t[d].reactions.heart+"</span>","</div>",'<div class="user-comment-body">'+(t[d].body_html||t[d].body)+"</div>","</div>","</li>"].join("");r.push(l)}if(c===1){u='<a href="javascript: void(0);" class="item current">'+e+"</a>";o.push(u)}else if(c<=n){for(var d=1;d<=c;d++){if(d===e){u='<a href="javascript: void(0);" class="item current">'+e+"</a>"}else{u='<a href="javascript: JELON.Actions.pageJump('+d+');" class="item">'+d+"</a>"}o.push(u)}if(e!==1){o.unshift('<a href="javascript: JELON.Actions.pageJump('+(e-1)+');" class="item">上一页</a>')}if(e!==c){o.push('<a href="javascript: JELON.Actions.pageJump('+(e+1)+');" class="item">下一页</a>')}}else if(c>n){if(e<=n){for(var d=1;d<=n;d++){if(d===e){u='<a href="javascript: void(0);" class="item current">'+e+"</a>"}else{u='<a href="javascript: JELON.Actions.pageJump('+d+');" class="item">'+d+"</a>"}o.push(u)}if(e!==1){o.unshift('<a href="javascript: JELON.Actions.pageJump('+(e-1)+');" class="item">上一页</a>')}o.push('<a href="javascript: JELON.Actions.pageJump('+(e+1)+');" class="item">下一页</a>');o.push('<a href="javascript: JELON.Actions.pageJump('+c+');" class="item">末页</a>')}else if(e>n&&e<=c-n){var p=e%n;var f=Math.floor(e/n)*n+1;var v=Math.ceil(e/n)*n;o.push('<a href="javascript: JELON.Actions.pageJump(1);" class="item">首页</a>');o.push('<a href="javascript: JELON.Actions.pageJump('+(e-1)+');" class="item">上一页</a>');for(var d=f;d<=v;d++){if(d===e){u='<a href="javascript: void(0);" class="item current">'+e+"</a>"}else{u='<a href="javascript: JELON.Actions.pageJump('+d+');" class="item">'+d+"</a>"}o.push(u)}o.push('<a href="javascript: JELON.Actions.pageJump('+(e+1)+');" class="item">下一页</a>');o.push('<a href="javascript: JELON.Actions.pageJump('+c+');" class="item">末页</a>')}else if(e>n&&e>c-n){var f=c-n+1;var v=c;o.push('<a href="javascript: JELON.Actions.pageJump(1);" class="item">首页</a>');o.push('<a href="javascript: JELON.Actions.pageJump('+(e-1)+');" class="item">上一页</a>');for(var d=f;d<=v;d++){if(d===e){u='<a href="javascript: void(0);" class="item current">'+e+"</a>"}else{u='<a href="javascript: JELON.Actions.pageJump('+d+');" class="item">'+d+"</a>"}o.push(u)}if(e!==c){o.push('<a href="javascript: JELON.Actions.pageJump('+(e+1)+');" class="item">下一页</a>')}}}i=['<header class="list-header">总共 <span class="comments-num" id="JELON__commentsNum">'+JL.issueComments+"</span> 条评论</header>",'<ul class="list">',r.join(""),"</ul>",'<div class="page-nav">',o.join(""),"</div>"].join("")}$("JELON__commentList").innerHTML=i;if(localStorage.getItem(constants.USER_INFO_KEY)){a&&a()}},reactionUpdate:function(e,s){var t=localStorage.getItem(constants.USER_INFO_KEY);if(t){t=JSON.parse(t)}else{return}var a=t.id;for(var n=0,i=s.length;n<i;n++){if(a===s[n].user.id){console.log(a,s[n].user.id);addClass($("JELON__comment_"+e+"_reactions").getElementsByClassName("like")[0],"liked");$("JELON__comment_"+e+"_reactions").getElementsByClassName("like")[0].innerHTML="已赞";break}}},addOne:function(e){var s=document.createElement("li");var t=['<div class="user-avatar">','<a target="_blank" href="'+e.user.html_url+'">','<img src="'+e.user.avatar_url+'" alt="user-avatar">',"</a>","</div>",'<div class="user-comment">','<div class="user-comment-header" id="JELON__comment_'+e.id+'_reactions">','<span class="post-name">'+e.user.login+"</span>",'<span class="post-time">'+e.created_at+"</span>",'<span class="like" onclick="JELON.Actions.like('+e.reactions.heart+')">点赞</span>','<span class="like-num">'+e.reactions.heart+"</span>","</div>",'<div class="user-comment-body">'+(e.body_html||e.body)+"</div>","</div>"].join("");s.innerHTML=t;var a=$("JELON__commentList").getElementsByTagName("ul")[0];if(a){a.insertBefore(s,a.firstChild);$("JELON__commentsNum").innerHTML=JL.issueComments+1}else{$("JELON__commentList").innerHTML=['<header class="list-header">总共 <span class="comments-num" id="JELON__commentsNum">'+(JL.issueComments+1)+"</span> 条评论</header>",'<ul class="list">',"<li>",t,"</li>","</ul>"].join("")}}},signBar:{tpl:['<div class="sign-bar" id="JELON__commentSignBar">',"</div>"].join(""),update:function(){var e=localStorage.getItem(constants.ACCESS_TOKEN_KEY);var s=localStorage.getItem(constants.USER_INFO_KEY);var t="";if(e&&s){t=['<span class="sign-txt">GitHub 已登录!</span>','<span class="sign-link" onclick="JELON.Actions.signOut()">登出</span>'].join("")}else{t=['<span class="sign-txt">GitHub 未登录?</span>','<a href="https://github.com/login/oauth/authorize?scope=public_repo&redirect_uri=',location.href.indexOf("?")!==-1?encodeURIComponent(location.href.substring(0,location.href.indexOf("?"))):encodeURIComponent(location.href),"&client_id="+JL.options.clientId+"&client_secret="+JL.options.clientSecret+'" class="sign-link">',"登录","</a>"].join("")}$("JELON__commentSignBar").innerHTML=t}},tips:function(){return'<section class="tips">注：评论支持 markdown 语法！</section>'}(),flashTitle:function(e){var s=0;document.title=e+"...";var t=setInterval(function(){s++;if(s%3===0){document.title=e+"..."}else if(s%3===1){document.title=e+".."}else if(s%3===2){document.title=e+"."}},100)},loading:{create:function(e){e=e||document.body;var s=document.createElement("div");s.className="loading-mask";s.id="JELON__loadingMask";s.innerHTML='<div class="loading-icon"><img src="/img/loading.gif" width="50" height="50" alt="加载中" ></div>';e.appendChild(s)},remove:function(){var e=$("JELON__loadingMask");e.parentNode.removeChild(e)}}};JL.Actions={init:function(){var e=queryUrl("code");JL.Renders.signBar.update();JL.Renders.box.update();if(e){JL.Renders.loading.create();JL.Renders.flashTitle("登录中");JL.Requests.getAccessToken({client_id:JL.options.clientId,client_secret:JL.options.clientSecret,code:e},function(e){if(e.access_token){localStorage.setItem(constants.ACCESS_TOKEN_KEY,e.access_token);JL.Requests.getUserInfo({access_token:e.access_token},function(e){if(e.login){localStorage.setItem(constants.USER_INFO_KEY,JSON.stringify(e));location.href=location.href.substring(0,location.href.indexOf("?"));JL.Renders.loading.remove()}})}else{location.href=location.href.substring(0,location.href.indexOf("?"));JL.Renders.loading.remove()}})}else{JL.Requests.getIssueNumberByLabel(JL.options.label,function(e){if(e.length>0){var s=e[0].number;var t=e[0].comments;JL.issueNumber=s;JL.issueComments=t;JL.Requests.getCommentListByIssueNumber(s,{page:1,per_page:constants.PER_PAGE},function(e){JL.Renders.list.update(1,t,e,function(){for(var s=0,t=e.length;s<t;s++){(function(e){JL.Requests.getReactionsByCommentId(e,{content:"heart",rnd:Math.random()},function(s){JL.Renders.list.reactionUpdate(e,s)})})(e[s].id)}})})}else{if(typeof e!=="object"){localStorage.removeItem(constants.ACCESS_TOKEN_KEY);localStorage.removeItem(constants.USER_INFO_KEY);JL.Renders.signBar.update();JL.Renders.box.update();location.reload()}else{JL.Renders.list.update(1,0,[])}}})}},signOut:function(){localStorage.removeItem(constants.ACCESS_TOKEN_KEY);localStorage.removeItem(constants.USER_INFO_KEY);JL.Renders.signBar.update();JL.Renders.box.update()},pageJump:function(e){JL.Requests.getCommentListByIssueNumber(JL.issueNumber,{page:Number(e),per_page:constants.PER_PAGE},function(s){JL.Renders.list.update(e,JL.issueComments,s,function(){for(var e=0,t=s.length;e<t;e++){(function(e){JL.Requests.getReactionsByCommentId(e,{content:"heart",rnd:Math.random()},function(s){JL.Renders.list.reactionUpdate(e,s)})})(s[e].id)}})})},editPreviewSwitch:function(e){if(e==="edit"){removeClass("JELON__previewSwitcher","on");addClass("JELON__editSwitcher","on");removeClass("JELON__previewBox","show");addClass("JELON__editBox","show")}else{removeClass("JELON__editSwitcher","on");addClass("JELON__previewSwitcher","on");removeClass("JELON__editBox","show");addClass("JELON__previewBox","show");var s=$("JELON__editBox").value.trim();if(s){JL.Requests.markdown({text:s,mode:"markdown",context:"github/gollum"},function(e){$("JELON__previewBox").innerHTML=e})}else{$("JELON__previewBox").innerHTML=""}}},postComment:function(){var e=localStorage.getItem(constants.ACCESS_TOKEN_KEY);var s=localStorage.getItem(constants.USER_INFO_KEY);if(!e||!s){alert("请先登录哦..!^_^");return}var t=$("JELON__editBox").value.trim();if(t){JL.Renders.loading.create();if(JL.issueNumber!==0){JL.Requests.createComment(JL.issueNumber,{body:t},function(e){if(e.id){JL.Renders.list.addOne(e);JL.issueComments++;$("JELON__editBox").value=""}JL.Renders.loading.remove()})}else{JL.Requests.createIssue({title:document.title,body:location.href,labels:[JL.options.label]},function(e){if(e.number){JL.issueNumber=e.number;JL.Requests.createComment(JL.issueNumber,{body:t},function(s){if(e.id){JL.Renders.list.addOne(s);JL.issueComments++;$("JELON__editBox").value=""}JL.Renders.loading.remove()})}})}}},like:function(e){var s=$("JELON__comment_"+e+"_reactions").getElementsByClassName("liked");var t=$("JELON__comment_"+e+"_reactions").getElementsByClassName("like")[0];var a=$("JELON__comment_"+e+"_reactions").getElementsByClassName("like-num")[0];if(s.length){return false}else{JL.Requests.createReaction(e,{content:"heart"},function(e){if(e.content==="heart"){addClass(t,"liked");t.innerHTML="已赞";a.innerHTML=Number(a.innerHTML)+1}})}}};JL.Requests={getIssueNumberByLabel:function(label,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues",method:"GET",data:{labels:[label]},success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},createIssue:function(data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues",method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},getCommentListByIssueNumber:function(number,data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues/"+number+"/comments",method:"GET",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},getReactionsByCommentId:function(id,data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues/comments/"+id+"/reactions",method:"GET",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},editIssue:function(number,data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.owner+"/issues/"+number,method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},markdown:function(e,s){ajax({url:constants.API_HOST+"/markdown",method:"POST",data:e,success:function(e){s&&s(e)},fail:function(e){s&&s(e)}})},getAccessToken:function(data,callback){ajax({url:"https://gh-oauth.imsun.net/",method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},getUserInfo:function(data,callback){ajax({url:constants.API_HOST+"/user",method:"GET",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},createComment:function(number,data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues/"+number+"/comments",method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},createReaction:function(commentId,data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues/comments/"+commentId+"/reactions",method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})}};JL.Comment=function(e){JL.options=e||{};$("comments").innerHTML=[this.Renders.signBar.tpl,this.Renders.box.tpl,this.Renders.tips,this.Renders.list.tpl].join("");JL.Actions.init()}})(JELON);