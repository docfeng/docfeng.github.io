if(!window["String"]["prototype"]["trim"]){window["String"]["prototype"]["trim"]=function(){return this.replace(/^\s+|\s+$/g,"")}}var JELON=window.JELON||{};(function(JL){var constants={ACCESS_TOKEN_KEY:"xups-github-comments-token",USER_INFO_KEY:"xups-github-user-info",PER_PAGE:5,API_HOST:"https://api.github.com"};var queryUrl=function(e,s,t){s=s||location.href;var a=new RegExp("(\\?|&|#|&amp;)"+e+"=([^?&#]*)");var i=s.match(a);if(t){return i?i[2]:""}return i?decodeURIComponent(i[2]):""};var $=JL.$||function(e){return/^(\[object HTML)[a-zA-Z]*(Element\])$/.test(Object.prototype.toString.call(e))?e:document.getElementById(e)};var addClass=function(e,s){if(!e)return;var t;var a;var i,n,r;if(e instanceof Array){for(i=0,n=e.length;i<n;i++){e[i]=arguments.callee.call(this,e[i],s)}}else if(typeof e.item==="function"){var o=[];for(i=0,n=e.length;i<n;i++){o.push(arguments.callee.call(this,e.item(i),s))}e=o}else{e=$(e);if(!e)return;if(s&&typeof s==="string"){t=s.split(/\s+/);if(e.nodeType===1){if(!e.className&&t.length===1){e.className=s}else{a=" "+e.className+" ";for(i=0,r=t.length;i<r;i++){if(a.indexOf(" "+t[i]+" ")<0){a+=t[i]+" "}}e.className=a.trim()}}}}return e};var removeClass=function(e,s){if(!e)return;var t,a,i,n,r;if(e instanceof Array){for(a=0,i=e.length;a<i;a++){e[a]=arguments.callee.call(this,e[a],s)}}else if(typeof e.item==="function"){var o=[];for(a=0,i=e.length;a<i;a++){o.push(arguments.callee.call(this,e.item(a),s))}e=o}else{e=$(e);if(!e)return;if(s&&typeof s==="string"||s===undefined){t=(s||"").split(/\s+/);if(e.nodeType===1&&e.className){if(s){s=(" "+e.className+" ").replace(/[\n\t\r]/g," ");for(n=0,r=t.length;n<r;n++){s=s.replace(" "+t[n]+" "," ")}e.className=s.trim()}else{e.className=""}}}}return e};var ajax=function(e){e=e||{};e.method=e.method.toUpperCase()||"POST";e.url=e.url||"";e.async=e.async||true;e.data=e.data||null;e.success=e.success||function(){};var s=null;if(window.XMLHttpRequest){s=new XMLHttpRequest}else{s=new ActiveXObject("Microsoft.XMLHTTP")}var t=[];var a=window.localStorage.getItem(constants.ACCESS_TOKEN_KEY);for(var i in e.data){t.push(i+"="+e.data[i])}var n=t.join("&");if(e.method.toUpperCase()==="POST"){s.open(e.method,e.url,e.async);if(window.JSON){n=JSON.stringify(e.data);s.setRequestHeader("Content-Type","application/json;charset=utf-8")}else{s.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8")}if(e.headers&&e.headers["Accept"]){s.setRequestHeader("Accept",e.headers["Accept"])}else{s.setRequestHeader("Accept","application/vnd.github.squirrel-girl-preview, application/vnd.github.html+json")}if(a){s.setRequestHeader("Authorization","token "+a)}s.send(n)}else if(e.method.toUpperCase()==="GET"){s.open(e.method,e.url+"?"+n,e.async);s.setRequestHeader("Accept","application/vnd.github.squirrel-girl-preview, application/vnd.github.html+json");if(a){s.setRequestHeader("Authorization","token "+a)}s.send(null)}s.onreadystatechange=function(){if(s.readyState===4){if(s.status>=200&&s.status<300){e.success&&e.success(s.responseText)}else{e.fail&&e.fail(s.status)}}};s.onerror=function(){e.fail&&e.fail({message:"请求错误！"})}};JL.issueComments=0;JL.issueNumber=0;JL.Utils={ajax:ajax,queryUrl:queryUrl,addClass:addClass,removeClass:removeClass};JL.Renders={box:{tpl:['<section class="box" id="JELON__commentBox">','<div class="com-avatar"><img id="JELON__loginAvatar" src="/img/unsigned_avatar.jpg" alt="avatar"></div>','<div class="com-text">','<div class="main">','<textarea class="text-area-edited show" id="JELON__editBox" placeholder="欢迎评论！"></textarea>','<div class="text-area-preview" id="JELON__previewBox"></div>',"</div>",'<div class="switch">','<div class="switch-item on" id="JELON__editSwitcher" onclick="JELON.Actions.editPreviewSwitch(\'edit\')">编辑</div>','<div class="switch-item" id="JELON__previewSwitcher" onclick="JELON.Actions.editPreviewSwitch(\'preview\')">预览</div>',"</div>",'<div class="button" onclick="JELON.Actions.postComment()">提交</div>',"</div>","</section>"].join(""),update:function(){var e=localStorage.getItem(constants.USER_INFO_KEY);if(e){e=JSON.parse(e)}else{e={}}$("JELON__loginAvatar").src=e.avatar_url||"/img/unsigned_avatar.jpg"}},list:{tpl:['<section class="list-wrap" id="JELON__commentList">',"</section>"].join(""),update:function(e,s,t){var a=5;var i="";var n=[];var r=[];var o=Math.ceil(s/constants.PER_PAGE);if(s===0){i='<div class="text-center">暂无评论</div>'}else{var c="";var l="";for(var u=0,d=t.length;u<d;u++){c=["<li>",'<div class="user-avatar">','<a href="'+t[u].user.url+'">','<img src="'+t[u].user.avatar_url+'" alt="user-avatar">',"</a>","</div>",'<div class="user-comment">','<div class="user-comment-header" id="JELON__comment_'+t[u].id+'_reactions">','<span class="post-name">'+t[u].user.login+"</span>",'<span class="post-time">'+t[u].created_at+"</span>",'<span class="like" onclick="JELON.Actions.like('+t[u].reactions.heart+')">点赞</span>','<span class="like-num">'+t[u].reactions.heart+"</span>","</div>",'<div class="user-comment-body">'+(t[u].body_html||t[u].body)+"</div>","</div>","</li>"].join("");n.push(c)}if(o===1){l='<a href="javascript: void(0);" class="item current">'+e+"</a>";r.push(l)}else if(o<=a){for(var u=1;u<=o;u++){if(u===e){l='<a href="javascript: void(0);" class="item current">'+e+"</a>"}else{l='<a href="javascript: JELON.Actions.pageJump('+u+');" class="item">'+u+"</a>"}r.push(l)}}else if(o>a){if(e<=a){for(var u=1;u<=a;u++){if(u===e){l='<a href="javascript: void(0);" class="item current">'+e+"</a>"}else{l='<a href="javascript: JELON.Actions.pageJump('+u+');" class="item">'+u+"</a>"}r.push(l)}r.push('<a href="javascript: JELON.Actions.pageJump('+u+');" class="item">下一页</a>')}else if(e>a&&e<=o-a){var p=e%a;var m=Math.floor(e/a)*a+1;var f=Math.ceil(e/a)*a;r.push('<a href="javascript: JELON.Actions.pageJump('+(m-1)+');" class="item">上一页</a>');for(var u=m;u<=f;u++){if(u===e){l='<a href="javascript: void(0);" class="item current">'+e+"</a>"}else{l='<a href="javascript: JELON.Actions.pageJump('+u+');" class="item">'+u+"</a>"}r.push(l)}r.push('<a href="javascript: JELON.Actions.pageJump('+(f+1)+');" class="item">下一页</a>')}else if(e>a&&e>o-a){var m=o-a+1;var f=o;r.push('<a href="javascript: JELON.Actions.pageJump('+(m-1)+');" class="item">上一页</a>');for(var u=m;u<=f;u++){if(u===e){l='<a href="javascript: void(0);" class="item current">'+e+"</a>"}else{l='<a href="javascript: JELON.Actions.pageJump('+u+');" class="item">'+u+"</a>"}r.push(l)}}}i=['<ul class="list">',n.join(""),"</ul>",'<div class="page-nav">',r.join(""),"</div>"].join("")}$("JELON__commentList").innerHTML=i},addOne:function(e){var s=document.createElement("li");var t=['<div class="user-avatar">','<a href="'+e.user.url+'">','<img src="'+e.user.avatar_url+'" alt="user-avatar">',"</a>","</div>",'<div class="user-comment">','<div class="user-comment-header" id="JELON__comment_'+e.id+'_reactions">','<span class="post-name">'+e.user.login+"</span>",'<span class="post-time">'+e.created_at+"</span>",'<span class="like" onclick="JELON.Actions.like('+e.reactions.heart+')">点赞</span>','<span class="like-num">'+e.reactions.heart+"</span>","</div>",'<div class="user-comment-body">'+(e.body_html||list[i].body)+"</div>","</div>"].join("");s.innerHTML=t;var a=$("JELON__commentList").getElementsByTagName("ul")[0];if(a){a.insertBefore(s,a.firstChild)}else{$("JELON__commentList").innerHTML=['<ul class="list">',"<li>",t,"</li>","</ul>"].join("")}}},signBar:{tpl:['<div class="sign-bar" id="JELON__commentSignBar">',"</div>"].join(""),update:function(){var e=localStorage.getItem(constants.ACCESS_TOKEN_KEY);var s=localStorage.getItem(constants.USER_INFO_KEY);var t="";if(e&&s){t=['<span class="sign-txt">GitHub 已登录!</span>','<span class="sign-link" onclick="JELON.Actions.signOut()">登出</span>'].join("")}else{t=['<span class="sign-txt">GitHub 未登录?</span>','<a href="https://github.com/login/oauth/authorize?scope=public_repo&redirect_uri='+encodeURIComponent(location.href)+"&client_id="+JL.options.clientId+"&client_secret="+JL.options.clientSecret+'" class="sign-link">登录</a>'].join("")}$("JELON__commentSignBar").innerHTML=t}},tips:function(){return'<section class="tips">注：评论支持 markdown 语法！</section>'}(),flashTitle:function(e){var s=0;document.title=e+"...";var t=setInterval(function(){s++;if(s%3===0){document.title=e+"..."}else if(s%3===1){document.title=e+".."}else if(s%3===2){document.title=e+"."}},100)}};JL.Actions={init:function(){var e=queryUrl("code");JL.Renders.signBar.update();JL.Renders.box.update();if(e){JL.Renders.flashTitle("登录中");JL.Requests.getAccessToken({client_id:JL.options.clientId,client_secret:JL.options.clientSecret,code:e},function(e){if(e.access_token){localStorage.setItem(constants.ACCESS_TOKEN_KEY,e.access_token);JL.Requests.getUserInfo({access_token:e.access_token},function(e){if(e.login){localStorage.setItem(constants.USER_INFO_KEY,JSON.stringify(e));location.href=location.href.substring(0,location.href.indexOf("?"))}})}else{location.href=location.href.substring(0,location.href.indexOf("?"))}})}else{JL.Requests.getIssueNumberByLabel(JL.options.label,function(e){if(e.length>0){var s=e[0].number;var t=e[0].comments;JL.issueNumber=s;JL.issueComments=t;JL.Requests.getCommentListByIssueNumber(s,{page:1,per_page:constants.PER_PAGE},function(e){JL.Renders.list.update(1,t,e)})}else{JL.Renders.list.update(1,0,[])}})}},signOut:function(){localStorage.removeItem(constants.ACCESS_TOKEN_KEY);localStorage.removeItem(constants.USER_INFO_KEY);JL.Renders.signBar.update();JL.Renders.box.update()},pageJump:function(e){JL.Requests.getCommentListByIssueNumber(JL.issueNumber,{page:Number(e),per_page:constants.PER_PAGE},function(s){JL.Renders.list.update(e,JL.issueComments,s)})},editPreviewSwitch:function(e){if(e==="edit"){removeClass("JELON__previewSwitcher","on");addClass("JELON__editSwitcher","on");removeClass("JELON__previewBox","show");addClass("JELON__editBox","show")}else{removeClass("JELON__editSwitcher","on");addClass("JELON__previewSwitcher","on");removeClass("JELON__editBox","show");addClass("JELON__previewBox","show");var s=$("JELON__editBox").value.trim();if(s){JL.Requests.markdown({text:s,mode:"markdown",context:"github/gollum"},function(e){$("JELON__previewBox").innerHTML=e})}else{$("JELON__previewBox").innerHTML=""}}},postComment:function(){var e=localStorage.getItem(constants.ACCESS_TOKEN_KEY);var s=localStorage.getItem(constants.USER_INFO_KEY);if(!e||!s){alert("请先登录哦..!^_^");return}var t=$("JELON__editBox").value.trim();if(t){if(JL.issueNumber!==0){JL.Requests.createComment(JL.issueNumber,{body:t},function(e){if(e.id){JL.Renders.list.addOne(e);JL.issueComments++}})}else{JL.Requests.createIssue({title:document.title,body:location.href,labels:[JL.options.label]},function(e){if(e.number){JL.issueNumber=e.number;JL.Requests.createComment(JL.issueNumber,{body:t},function(s){if(e.id){JL.Renders.list.addOne(s);JL.issueComments++}})}})}}},like:function(){alert("点赞操作正在开发中")}};JL.Requests={getIssueNumberByLabel:function(label,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues",method:"GET",data:{labels:[label]},success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},createIssue:function(data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues",method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},getCommentListByIssueNumber:function(number,data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues/"+number+"/comments",method:"GET",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},editIssue:function(number,data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.owner+"/issues/"+number,method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},markdown:function(e,s){ajax({url:constants.API_HOST+"/markdown",method:"POST",data:e,success:function(e){s&&s(e)},fail:function(e){s&&s(e)}})},getAccessToken:function(data,callback){ajax({url:"https://gh-oauth.imsun.net/",method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},getUserInfo:function(data,callback){ajax({url:constants.API_HOST+"/user",method:"GET",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})},createComment:function(number,data,callback){ajax({url:constants.API_HOST+"/repos/"+JL.options.owner+"/"+JL.options.repo+"/issues/"+number+"/comments",method:"POST",data:data,success:function(res){if(typeof res==="string"){if(window.JSON){res=JSON.parse(res)}else{res=eval("("+res+")")}}callback&&callback(res)},fail:function(e){callback&&callback(e)}})}};JL.Comment=function(e){JL.options=e||{};$("comments").innerHTML=[this.Renders.signBar.tpl,this.Renders.box.tpl,this.Renders.tips,this.Renders.list.tpl].join("");JL.Actions.init()}})(JELON);